<?require_once ('../../phpincludes/db.php');require_once ('../../phpincludes/Auth.php');require_once ('../../phpincludes/User.class.php');require_once ('../../phpincludes/Service.class.php');require_once ('header.php');require_once ('core.php');echo "<title>OpenSpy Admin Panel</title>";echo "<center>";if(isLoggedIn()) {	showMenu();} else {	die('You are not logged in.');}function showMenu() {	if(isset($_GET['action']) && $_GET['action'] == "editservice") {		showEditServiceMenu(intval($_GET['id']));	} else if(isset($_GET['action']) && $_GET['action'] == "editservicekeys") {		showEditServiceKeys(intval($_GET['id']));	}  else if(isset($_GET['action']) && $_GET['action'] == "editdetection") {		showEditDetectionKeys(intval($_GET['id']));	} else if(isset($_GET['action']) && $_GET['action'] == "editfiles") {		if(isset($_POST["uploadfile"])) {			if($_FILES["file"]["error"] > 0) {				die('Error: '. $_FILES["file"]["error"]);			}			$fsvid = intval($_POST['fsvid']);			$num1 = intval($_POST['num1']);			$num2 = intval($_POST['num2']);			$id = intval($_POST['serviceid']);			$data = file_get_contents($_FILES["file"]["tmp_name"]);			$name = mysqli_real_escape_string($GLOBALS['confDBLink'],$_POST['name']);			if(strlen($name) < 1) {				die('A name is required');			}			$query = "INSERT INTO `MOTDWeb`.`files` (`serviceid`,`num1`,`num2`,`fsvid`,`data`,`name`) VALUES ($id, $num1, $num2, $fsvid, 0x".bin2hex($data).",\"$name\")";			gs_query($query);		}		showEditFiles(intval($_GET['id']));	} else if(isset($_GET['action']) && $_GET['action'] == "togfileactive") {		if(!isset($_GET['active'])) {			die('active is not set');		}		$active = intval($_GET['active'])==1?1:0;		if(!isset($_GET['id'])) {				die('id is not set');		}		$query = "UPDATE `MOTDWeb`.`files` SET `active` = $active WHERE `fileid` = ".intval($_GET['id']);		gs_query($query);		if($active == 1) {			echo "File marked active";		} else {			echo "File marked inactive";		}	} else if(isset($_GET['action']) && $_GET['action'] == "deletefile") {		if(!isset($_GET['id'])) {				die('id is not set');		}		$query = "DELETE FROM `MOTDWeb`.`files` WHERE `fileid` = ".intval($_GET['id']);		gs_query($query);		echo "File deleted.";	} else if(isset($_GET['action']) && $_GET['action'] == "updateservicekeys") {		$keys = mysqli_real_escape_string($GLOBALS['confDBLink'],$_GET['keys']);		$keys = str_replace("\\r","",$keys);		$serviceid = intval($_GET['serviceid']);		$query = "UPDATE `MOTDWeb`.`services` SET `keys` = '$keys', `modified` = CURRENT_TIMESTAMP WHERE `id` = $serviceid";		gs_query($query);		echo "Updated!<br>";		showEditServiceKeys($serviceid);	} else if(isset($_GET['action']) && $_GET['action'] == "updatedetectkeys") {		$keys = mysqli_real_escape_string($GLOBALS['confDBLink'],$_GET['keys']);		$keys = str_replace("\\r","",$keys);		$serviceid = intval($_GET['serviceid']);		$res = gs_query("SELECT 1 FROM `MOTDWeb`.`detection` WHERE `id` = ".$serviceid);		if(mysqli_num_rows($res) < 1) {		$query = "INSERT INTO `MOTDWeb`.`detection` (`id`,`keys`) VALUES ($serviceid,\"$keys\")";		} else {		$query = "UPDATE `MOTDWeb`.`detection` SET `keys` = '$keys', `modified` = CURRENT_TIMESTAMP WHERE `id` = $serviceid";		}		gs_query($query);		echo "Updated!<br>";		showEditDetectionKeys($serviceid);	} else if(isset($_GET['action']) && $_GET['action'] == "addservice") {		if(!isset($_GET['name'])) {				echo "Add Service:		<form name=\"input\" method=\"get\" enctype=\"multipart/form-data\">Name: <input type=\"text\" name=\"name\">		<input type=\"hidden\" name=\"action\" value=\"addservice\"><input type=\"submit\" value=\"Submit\" />";		echo "</form>";		} else {			$name = mysqli_real_escape_string($GLOBALS['confDBLink'],$_GET['name']);			$query = "INSERT INTO `MOTDWeb`.`services` (`name`) VALUES (\"$name\")";			gs_query($query);			$res = gs_query("SELECT LAST_INSERT_ID()");			while($row = mysqli_fetch_row($res)) {				echo "<meta http-equiv=\"REFRESH\" content=\"0;url=?action=editservice&id=".$row[0]."\">";				echo "Redirecting... <a href=\"?action=editservice&id=".$row[0]."\">Click Here</a> if it fails";			}		}	} else if(isset($_GET['action']) && $_GET['action'] == "togserviceactive") {		if(isset($_GET['active'])) {			$active = intval($_GET['active']);		} else {			$active = 0;		}		if(isset($_GET['id'])) {			$serviceid = intval($_GET['id']);		} else {			die('invalid serviceid');		}		$service = new Service($serviceid);		 if(!$service->found()) {			die('invalid serviceid');		}				$query = "UPDATE `MOTDWeb`.`services` SET `active` = $active WHERE `id` = $serviceid";		gs_query($query);		echo "<meta http-equiv=\"REFRESH\" content=\"0;url=?action=editservice&id=".$serviceid."\">";		echo "Redirecting... <a href=\"?action=editservice&id=".$serviceid."\">Click Here</a> if it fails";	} else {	$query = "SELECT `id`,`name`,`active` FROM `MOTDWeb`.`services` ORDER BY `id` DESC";	$result = gs_query($query);			echo "Services: 			<a href=\"?action=addservice\">Add New Service</a><br>			<table border=\"1\">	<tr>	<th>Name</th>	<th>Edit</th>	<th>Active</th>	</tr>";	while($row = mysqli_fetch_row($result)) {		echo "<tr><th>".$row[1]."</th>		<th><a href=\"?action=editservice&id=".$row[0]."\">Edit</a></th>		<th>".$row[2]."</th>		</tr>";			}	}}function showEditServiceMenu($id) {	echo "<a href=\"?action=editservicekeys&id=$id\">Edit Keys</a><br>";	echo "<a href=\"?action=editfiles&id=$id\">Add/Remove files</a><br>";	echo "<a href=\"?action=editdetection&id=$id\">Edit Detection</a><br>";	$service = new Service($id);	if($service->isActive()) {	echo "<th><a href=\"?action=togserviceactive&active=0&id=$id\">Deactivate</a></th>";	} else {	echo "<th><a href=\"?action=togserviceactive&active=1&id=$id\">Activate</a></th>";	}}function showEditFiles($id) {	$service = new Service($id);	if(!$service->found()) {		die('Service not found');	}	$files = $service->getFiles();	echo "Service Files(".$service->getName()."): 		<form name=\"input\" method=\"post\" enctype=\"multipart/form-data\">		<table border=\"1\">	<tr>	<th>Name</th>	<th>fsvid</th>	<th>Num 1</th>	<th>Num 2</th>	<th>Uploaded</th>	<th>Delete</th>	<th>Active</th>	</tr>";	foreach($files as $file) {		echo "<tr><th><a href=\"http://motd.openspy.org/software/services/".$service->getName()."/".$file->getfsvid()."/".$file->getName()."\">".$file->getName()."</a></th>";		echo "<th>".$file->getfsvid()."</th>";		echo "<th>".$file->getNum(1)."</th>";		echo "<th>".$file->getNum(2)."</th>";		echo "<th>".date('j/n/Y h:i:s',$file->getModified())."</th>";		echo "<th><a href=\"?action=deletefile&id=".$file->getID()."\">Delete</a></th>";		$fileactive = $file->isActive();		if($fileactive) {			echo "<th><a href=\"?action=togfileactive&active=0&id=".$file->getID()."\">Deactivate</a></th>";		} else {			echo "<th><a href=\"?action=togfileactive&active=1&id=".$file->getID()."\">Activate</a></th>";		}		echo "</tr>";	}	echo "</table>";	echo "Upload File: <br><label for=\"file\">Filename:</label>		<input type=\"file\" name=\"file\" id=\"file\" />  <br>		Name: <input type=\"text\" name=\"name\"/> <br>		Num 1: <input type=\"text\" name=\"num1\"/ value=\"0\"> <br>		Num 2: <input type=\"text\" name=\"num2\"/ value=\"0\"> <br>		fsvid: <input type=\"text\" name=\"fsvid\"/ value=\"".$service->getfsvid()."\"> <br>		<input type=\"hidden\" name=\"uploadfile\" value=\"1\">		<input type=\"hidden\" name=\"serviceid\" value=\"".$id."\">		<br><input type=\"submit\" name=\"submit\" value=\"Submit\" />";	echo "</form>";}function showEditServiceKeys($id) {	$service = new Service($id);	if(!$service->found()) {		die('Service not found');	}	$files = $service->getFiles();	echo "Service Files(".$service->getName()."): 		<form name=\"input\" method=\"get\" enctype=\"multipart/form-data\">		<textarea name=\"keys\" cols=\"40\" rows=\"5\">";		$keys = $service->getKeys();		foreach($keys as $key) {			echo $key."\n";		}		echo "</textarea><br><input type=\"hidden\" name=\"action\" value=\"updateservicekeys\"><input type=\"hidden\" name=\"serviceid\" value=\"".$id."\"><input type=\"submit\" value=\"Submit\" />";		echo "</form>";}function showEditDetectionKeys($id) {	$service = new Service($id);	if(!$service->found()) {		die('Service not found');	}	$files = $service->getFiles();	echo "Service Files(".$service->getName()."): 		<form name=\"input\" method=\"get\" enctype=\"multipart/form-data\">		<textarea name=\"keys\" cols=\"40\" rows=\"5\">";		$keys = $service->getDetect();		echo $keys;		echo "</textarea><br><input type=\"hidden\" name=\"action\" value=\"updatedetectkeys\"><input type=\"hidden\" name=\"serviceid\" value=\"".$id."\"><input type=\"submit\" value=\"Submit\" />";		echo "</form>";}echo "</center>";?>